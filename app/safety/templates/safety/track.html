{% extends "safety/base.html" %}

{% block title %}Track Trip - {{ trip.title }}{% endblock %}

{% block safety_head %}
<style>
    .map-container {
        height: 70vh;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .alert-panel {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 1rem;
    }
    
    .alert-item {
        padding: 0.75rem;
        border-left: 4px solid #fbbf24;
        background: #fef3c7;
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }
    
    .alert-item.high {
        border-left-color: #f87171;
        background: #fef2f2;
    }
    
    .alert-item.critical {
        border-left-color: #dc2626;
        background: #fef2f2;
    }
    
    .status-indicators {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .status-item {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        flex: 1;
        text-align: center;
    }
    
    .status-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #059669;
    }
    
    .status-label {
        font-size: 0.875rem;
        color: #6b7280;
    }
    
    .connection-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
    }
    
    .connection-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #dc2626;
    }
    
    .connection-dot.connected {
        background: #059669;
    }
    
    .device-list {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .device-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .device-item:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block safety_content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900">{{ trip.title }}</h1>
        <p class="text-gray-600 mt-2">Real-time trip monitoring and safety tracking</p>
        
        <div class="connection-status mt-4">
            <div id="connection-dot" class="connection-dot"></div>
            <span id="connection-status">Connecting...</span>
        </div>
    </div>
    
    <!-- Status Indicators -->
    <div class="status-indicators">
        <div class="status-item">
            <div id="active-devices" class="status-value">0</div>
            <div class="status-label">Active Devices</div>
        </div>
        <div class="status-item">
            <div id="last-update" class="status-value">--</div>
            <div class="status-label">Last Update</div>
        </div>
        <div class="status-item">
            <div id="active-alerts" class="status-value">{{ recent_alerts|length }}</div>
            <div class="status-label">Active Alerts</div>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Map -->
        <div class="lg:col-span-2">
            <div class="alert-panel">
                <h2 class="text-xl font-semibold mb-4">Live Location Tracking</h2>
                <div id="map" class="map-container"></div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="lg:col-span-1">
            <!-- Active Alerts -->
            <div class="alert-panel">
                <h3 class="text-lg font-semibold mb-3">Active Alerts</h3>
                <div id="alerts-container">
                    {% if recent_alerts %}
                        {% for alert in recent_alerts %}
                        <div class="alert-item {{ alert.severity }}" data-alert-id="{{ alert.id }}">
                            <div class="font-medium">{{ alert.severity.title() }} Alert</div>
                            <div class="text-sm text-gray-600">{{ alert.message }}</div>
                            <div class="text-xs text-gray-500 mt-1">
                                {{ alert.created_at.strftime('%H:%M') }}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-gray-500 text-sm">No active alerts</p>
                    {% endif %}
                </div>
                
                <!-- Emergency Alert Button -->
                <button id="emergency-btn" class="w-full mt-4 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition-colors">
                    Send Emergency Alert
                </button>
            </div>
            
            <!-- Device Status -->
            <div class="device-list">
                <h3 class="text-lg font-semibold mb-3">Tracked Devices</h3>
                <div id="devices-container">
                    {% for location in latest_locations %}
                    <div class="device-item" data-device-id="{{ location.device_id }}">
                        <div>
                            <div class="font-medium">{{ location.device_id }}</div>
                            <div class="text-sm text-gray-500">{{ location.device_type.title() }}</div>
                        </div>
                        <div class="text-right">
                            {% if location.battery_level %}
                            <div class="text-sm">{{ location.battery_level }}%</div>
                            {% endif %}
                            <div class="text-xs text-gray-500">
                                {{ location.timestamp.strftime('%H:%M') }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Emergency Alert Modal -->
<div id="emergency-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6">
            <h3 class="text-lg font-semibold mb-4">Send Emergency Alert</h3>
            <form id="emergency-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Severity</label>
                    <select id="severity" class="w-full border border-gray-300 rounded px-3 py-2">
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
                    <textarea id="alert-message" class="w-full border border-gray-300 rounded px-3 py-2 h-24" 
                              placeholder="Describe the emergency situation..." required></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Location Description</label>
                    <input type="text" id="location-desc" class="w-full border border-gray-300 rounded px-3 py-2" 
                           placeholder="Where is the emergency occurring?">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" id="cancel-alert" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                        Send Alert
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
window.tripData = {
    tripId: {{ trip.id }},
    initialLocations: {{ (latest_locations | map(attribute='serialize') | list) | tojson }},
    userRole: '{{ current_user.role }}'
};
</script>
{% endblock %}

{% block safety_scripts %}
<script>
// Initialize trip tracking
document.addEventListener('DOMContentLoaded', function() {
    if (typeof SafetyTracker !== 'undefined') {
        window.safetyTracker = new SafetyTracker(window.tripData);
    }
});
</script>
{% endblock %}